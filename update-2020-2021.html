<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>2020-2021年 Topix更新</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .btn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            border-radius: 4px;
            border: none;
        }
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #0f9d58;
        }
        .month-section {
            color: #1a73e8;
            font-weight: bold;
            margin-top: 10px;
        }
        .summary {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>2020-2021年のTopixを更新</h1>
    <div class="summary">
        <h3>更新対象：14ヶ月分</h3>
        <p>2020-10、2020-11、2020-12、2021-01、2021-02、2021-03、2021-04、2021-05、2021-07、2021-08、2021-09、2021-10、2021-11、2021-12</p>
    </div>

    <button class="btn btn-primary" onclick="updateTopix()">更新実行</button>
    <button class="btn" onclick="location.href='index.html'">アプリに戻る</button>

    <div class="log" id="log"></div>

    <script>
        function log(message, isMonthHeader = false) {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            p.className = isMonthHeader ? 'month-section' : 'success';
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateTopix() {
            // 更新するデータ
            const updates = {
                '2020-10': ['キャンプ2回', 'なつきダイエット（食費少なめ）'],
                '2020-11': ['車検', 'なつきダイエット（食費少なめ）'],
                '2020-12': ['ふるさと納税', 'ディズニーシー'],
                '2021-01': ['デスク'],
                '2021-02': ['フォトナ3D・大阪'],
                '2021-03': ['哲太チェアー'],
                '2021-04': ['家ごはんキャンペーン', '固定資産税'],
                '2021-05': ['結婚記念日', '整骨院回数券', '車税金', 'ウッドデッキ'],
                '2021-07': ['鴨川シーワールド', '水戸旅行・SUP'],
                '2021-08': ['ワイン＆チーズ', 'ふるさと納税'],
                '2021-09': ['旅行・日光'],
                '2021-10': ['美容：成田マッサージ', 'ジョイフルアスレティッククラブ（2ヶ月分）', '哲太英会話', 'ふるさと納税'],
                '2021-11': ['来客（大崎さん）'],
                '2021-12': ['美容：フォトナ', '車両保険', '大阪帰省']
            };

            log('更新を開始します...');
            log(`対象: ${Object.keys(updates).length}ヶ月分`);

            // 既存のメモデータを取得
            const existingMemos = JSON.parse(localStorage.getItem('monthlyMemos') || '{}');

            let totalAdded = 0;
            let totalSkipped = 0;
            let monthsUpdated = 0;

            // 各月を更新
            for (const [yearMonth, newEvents] of Object.entries(updates)) {
                log(`\n【${yearMonth}】を更新中...`, true);

                // その月のデータを取得
                const memo = existingMemos[yearMonth] || { events: '', plans: '', notes: '' };

                // 既存のイベントを配列に変換
                const currentEvents = memo.events ? memo.events.split('\n').filter(e => e.trim()) : [];

                log(`現在のTopix数: ${currentEvents.length}件`);

                let addedThisMonth = 0;

                // 重複チェックしながら追加
                newEvents.forEach(event => {
                    if (!currentEvents.includes(event)) {
                        currentEvents.push(event);
                        log(`  ✓ 追加: ${event}`);
                        totalAdded++;
                        addedThisMonth++;
                    } else {
                        log(`  - 既に存在: ${event}`);
                        totalSkipped++;
                    }
                });

                // データを更新
                existingMemos[yearMonth] = {
                    events: currentEvents.join('\n'),
                    plans: memo.plans || '',
                    notes: memo.notes || ''
                };

                log(`更新後のTopix数: ${currentEvents.length}件 (${addedThisMonth}件追加)`);

                if (addedThisMonth > 0) {
                    monthsUpdated++;
                }
            }

            // localStorageに保存
            localStorage.setItem('monthlyMemos', JSON.stringify(existingMemos));

            log(`\n========== 完了 ==========`, true);
            log(`${monthsUpdated}ヶ月を更新しました`);
            log(`合計 ${totalAdded}件のTopixを追加 (${totalSkipped}件はスキップ)`);
            log(`========================`, true);

            setTimeout(() => {
                if (confirm('更新が完了しました。アプリを開きますか？')) {
                    location.href = 'index.html';
                }
            }, 1500);
        }

        // ページ読み込み時に現在のデータを表示
        window.onload = function() {
            const existingMemos = JSON.parse(localStorage.getItem('monthlyMemos') || '{}');
            const months = ['2020-10', '2020-11', '2020-12', '2021-01', '2021-02', '2021-03',
                           '2021-04', '2021-05', '2021-07', '2021-08', '2021-09', '2021-10',
                           '2021-11', '2021-12'];

            log('現在のデータを確認中...');

            months.forEach(month => {
                const memo = existingMemos[month] || { events: '' };

                if (memo.events) {
                    const events = memo.events.split('\n').filter(e => e.trim());
                    log(`【${month}】現在 ${events.length}件のTopix`);
                } else {
                    log(`【${month}】現在Topixなし`);
                }
            });

            log('\n準備完了。「更新実行」ボタンをクリックしてください。', true);
        };
    </script>
</body>
</html>
